> `SYN`：标志位，表示这是一个建立连接的数据包。  
> `ACK`：标志位，表示这是一个确认消息的数据包。  
> `FIN`：标志位，表示这是一个关闭连接的数据包。  
> `seq`：序列号，第一个序列号由时间生成，每`4ms`加1，达到最大值后重置为0，后续数据传输中每传输一个字节增长1。  
> `ack`：确认号，确认消息的序列号加1，标志位`ACK`为1的时候才有效。
# 1. `TCP`三次握手流程
建立连接前，服务端状态处于`LISTEN`状态。  
## 1.1 客户端请求
客户端发送建立请求包，且状态变更为`SYN_SEND`
|字段名|值|
| :-: | :-: |
|SYN|1|
|seq|200|

## 1.2 服务端应答
服务端收到客户端的数据包，且发现包中的标志位`SYN=1`，明白客户端要建立连接，于是打开连接且回复收到建立连接请求确认消息，且状态变更为`SYN_RCVD`
|字段名|值|
| :-: | :-: |
|SYN|1|
|ACK|1|
|seq|400|
|ack|201|

## 1.3 客户端应答
客户端收到服务端的包，发现包中的标志位`SYN=1`、`ACK=1`，于是检查`ack`中的字段是上一次发包的序列号200+1，确认无误后打开连接，且发送确认消息，状态变更为`ESTABLISHED`。  
|字段名|值|
| :-: | :-: |
|ACK|1|
|seq|201|
|ack|401|

## 1.4 服务端连接
服务端收到客户端应答包，发现标志位`ACK=1`，于是检查`ack`中的字段是上一次发包的序列号400+1无误后，状态变更为`ESTABLISHED`。  

# 2. `TCP`四次挥手流程
## 2.1 客户端请求
客户端发送关闭连接请求，状态变更为`FIN_WAIT-1`。  
此时客户端已经关闭了发送数据的能力，但仍可接收数据。  
假如在上次建立连接后客户端向服务端传输了2000字节的数据，此时`seq=200+1+2000=2201`。  
|字段名|值|
| :-: | :-: |
|FIN|1|
|seq|2201|
## 2.2 服务端应答
服务端收到数据包，发现标志位`FIN=1`，确认客户端请求关闭连接，发送回复消息，状态变更为`CLOSE_WAIT`。  
此时服务端仍然可能会继续往客户端发送未发送完的数据。  
假如上次建立连接后服务端向客户端传输了1500字节的数据，此时`seq=1500+300=1800`。  
|字段名|值|
| :-: | :-: |
|ACK|1|
|seq|1800|
|ack|2202|
## 2.3 客户端变更状态
客户端收到待确认数据包，且确认无误，状态变更为`FIN_WAIT-2`
## 2.4 服务端确认关闭
服务端数据发送完毕，向客户端发送服务端关闭确认信号，状态变更为`LAST_ACK`。  
假如上次应答后，仍发送100字节的数据，此时`seq=1500+300+100=1900`。  
|字段名|值|
| :-: | :-: |
|FIN|1|
|ACK|1|
|seq|1900|
|ack|2202|
## 2.5 客户端应答
客户端收到服务端发送的确认关闭数据包，且确认无误，向服务端发送客户端关闭确认信号，状态变更为`TIME-WAIT`。  
|字段名|值|
| :-: | :-: |
|ACK|1|
|seq|2202|
|ack|1901|
在发送完数据包后，客户端等待`2MSL`，然后关闭，状态变更为`2MSL`。  
## 2.6 服务端关闭
服务端收到数据包，且确认无误，服务端关闭，状态变更为`CLOSED`。  

# 3. 常见问题
## 3.1 为什么要进行三次握手？
为了能确认客户端和服务端双方的收发能力正常。  
第一次握手，服务端确认客户端发送能力正常。  
第二次握手，客户端确认服务端发送能力和接收能力正常。  
第三次握手，服务端确认客户端接收能力正常。  

## 3.2 为什么四次挥手后，客户端要等待`2MSL`才关闭？
1. 为了确保最后一次握手的消息能被服务器收到，保证服务器正常关闭。
`1MSL`为一个数据包在网络中最长的存活时间，最后一次握手的包因网络延迟丢失，服务端将不会关闭，且会重发第三次挥手的数据包。  
在第四次握手后，客户端等待`2MSL`即留足时间保证第四次握手的消息能送达，且第四次握手如果没送达，服务端重发的第三次握手的消息能够接收到。  
如果客户端立即关闭的话，将收不到服务端重发的包，服务端无法正常关闭。  
2. 为了确保本连接内所有报文都从网络中消失，防止下一个新连接收到旧报文。  

## 3.3 客户端故障了，服务端连接会一直占用吗？
服务器维护了一个保活计时器，服务器每次收到客户端消息都会重置计时器，计时器通常为2小时。  
如果计时器到期客户端还未回复消息，则会发送探测报文，每隔`75s`发送一次，连续发送10次客户端都未回复，则判断客户端故障，服务端关闭连接。  